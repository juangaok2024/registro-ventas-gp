{
  "memories": [
    {
      "id": "mem_1766520271381_1mx0xn1ut",
      "content": "Created CLAUDE.md for registro_ventas_gp project - Sales Tracker that captures WhatsApp sales via Evolution API webhooks, stores in Firebase Firestore, displays on Next.js dashboard. Key architecture: WhatsApp Group → Evolution API → /api/webhook/evolution → Firestore → Dashboard",
      "type": "concept",
      "tags": [
        "concept",
        "api",
        "proyecto",
        "claude-md",
        "sales-tracker",
        "registro_ventas_gp"
      ],
      "timestamp": "2025-12-23T20:04:31.380Z",
      "context": "Initial /init command for the sales tracker project",
      "accessCount": 0,
      "lastAccessed": "2025-12-23T20:04:31.380Z",
      "lastVerified": "2025-12-23T20:04:31.380Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766526201190_j36z3svaj",
      "content": "Bug encontrado en webhook Evolution API - registro_ventas_gp:\n\nPROBLEMA: Los mensajes tipo \"conversation\" que citan imágenes no se vinculan correctamente.\n\nCAUSA: El código busca contextInfo solo en `data.message.extendedTextMessage.contextInfo`, pero cuando es mensaje tipo \"conversation\", el contextInfo viene en `data.contextInfo` (a nivel de data, no de message).\n\nSOLUCIÓN: Modificar líneas 111 y 133 para buscar contextInfo en ambas ubicaciones:\n1. `data.message?.extendedTextMessage?.contextInfo`\n2. `data.contextInfo`\n\nArchivo: app/api/webhook/evolution/route.ts",
      "type": "error",
      "tags": [
        "error",
        "api",
        "bug",
        "webhook",
        "evolution-api",
        "registro_ventas_gp"
      ],
      "timestamp": "2025-12-23T21:43:21.190Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-23T21:43:21.190Z",
      "lastVerified": "2025-12-23T21:43:21.190Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766526879412_482u51yu5",
      "content": "Corrección webhook Evolution API - registro_ventas_gp:\n\nPROBLEMA RESUELTO: Las imágenes no se mostraban porque se guardaba la URL encriptada de WhatsApp (mmg.whatsapp.net) en vez de la URL de Evolution API.\n\nSOLUCIÓN:\n1. Usar SOLO `data.message.mediaUrl` para guardar la URL de imágenes/documentos\n2. NO usar `imageMessage.url` o `documentMessage.url` porque son URLs encriptadas temporales\n3. Eliminar fallback a quotedMessage URLs encriptadas\n\nFLUJO CORRECTO:\n1. Imagen llega → guardar `data.message.mediaUrl` en collection proofs\n2. Texto citando imagen → buscar en proofs por `stanzaId` (que coincide con messageId de la imagen)",
      "type": "general",
      "tags": [
        "general",
        "api",
        "fix",
        "webhook",
        "evolution-api",
        "registro_ventas_gp",
        "mediaUrl"
      ],
      "timestamp": "2025-12-23T21:54:39.412Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-23T21:54:39.412Z",
      "lastVerified": "2025-12-23T21:54:39.412Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766531388633_5a10ilkpf",
      "content": "Local dev server fixed and running on port 3002. Sales API returns data correctly. Issue was old Next.js instances occupying ports 3000/3001. Fixed by cleaning .next cache and restarting. The proofMessageId field is now being saved as the stanzaId from contextInfo to link sales with their proof images.",
      "type": "troubleshooting",
      "tags": [
        "troubleshooting",
        "api",
        "sales-tracker",
        "fix",
        "local-dev",
        "port-3002"
      ],
      "timestamp": "2025-12-23T23:09:48.633Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-23T23:09:48.633Z",
      "lastVerified": "2025-12-23T23:09:48.633Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766532062681_w6n47074u",
      "content": "Evolution API Webhook flow for linking sales with proofs:\n\n1. IMAGE webhook arrives:\n   - data.key.id = unique message ID (use for linking)\n   - data.message.mediaUrl = S3 URL (CORRECT - use this)\n   - data.message.imageMessage.url = WhatsApp mmg URL (WRONG - expires)\n   - Save to 'proofs' collection with messageId\n\n2. TEXT with quote webhook arrives:\n   - data.contextInfo.stanzaId = ID of quoted message (the image)\n   - data.message.conversation = sale report text\n   - contextInfo can be at: data.contextInfo OR data.message.extendedTextMessage.contextInfo\n   \n3. Linking logic:\n   - IMAGE.data.key.id === TEXT.data.contextInfo.stanzaId\n   - Search proofs WHERE messageId == stanzaId\n   - Use the proof's mediaUrl (S3) for the sale\n\nCurrent implementation in route.ts is CORRECT and follows this pattern.",
      "type": "concept",
      "tags": [
        "concept",
        "api",
        "evolution-api",
        "webhook",
        "sales-tracker",
        "linking",
        "stanzaId",
        "mediaUrl"
      ],
      "timestamp": "2025-12-23T23:21:02.681Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-23T23:21:02.681Z",
      "lastVerified": "2025-12-23T23:21:02.681Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766949718573_7y86wqlfy",
      "content": "## Mejora Propuesta: Registro Completo de Chat\n\n### Idea\nCrear colección `messages` que guarde TODOS los mensajes del grupo WhatsApp, no solo ventas/comprobantes. Permite ver mensajes referenciados, contexto de ventas, y auditoría completa.\n\n### Arquitectura\n- Nueva colección `messages` con TODOS los mensajes\n- Campo `classification` para marcar si es venta/comprobante\n- Campo `quotedMessageId` para referencias entre mensajes\n- Mantener colecciones `sales` y `proofs` existentes (no eliminar)\n\n### Fases de Implementación\n1. Tipo ChatMessage + guardar todos mensajes en webhook\n2. Sistema de referencias (quotedMessageId → resolver)\n3. Nueva página /chat con timeline\n4. Mejorar vista de ventas con mensajes citados visibles",
      "type": "general",
      "tags": [
        "general",
        "architecture",
        "feature",
        "chat-history",
        "messages"
      ],
      "timestamp": "2025-12-28T19:21:58.573Z",
      "context": "Usuario propuso mejorar el sistema para tener registro completo del chat",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T19:21:58.573Z",
      "lastVerified": "2025-12-28T19:21:58.573Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766950458579_724r98eky",
      "content": "## Feature Implementada: Registro Completo de Chat con Hover en Ventas\n\n### Archivos Creados/Modificados:\n- `types/sales.ts` - Añadido tipo ChatMessage con parsedSale para preview\n- `app/api/webhook/evolution/route.ts` - Modificado para guardar TODOS los mensajes en colección 'messages'\n- `app/api/messages/route.ts` - Nueva API para obtener mensajes con filtros\n- `components/SalePreviewCard.tsx` - Card de preview para hover en ventas\n- `components/MessageBubble.tsx` - Burbuja de mensaje con hover interactivo\n- `app/chat/page.tsx` - Nueva página de timeline del chat\n- `firestore.indexes.json` - Añadidos índices para colección messages\n\n### Flujo:\n1. Webhook guarda TODO mensaje en `messages`\n2. Si es venta → también en `sales` + actualiza classification.saleId\n3. Si es media → también en `proofs` + actualiza classification.proofId\n4. Chat page muestra timeline con badges de Venta/Comprobante\n5. Hover en venta muestra SalePreviewCard con datos procesados\n6. Click navega al dashboard con la venta seleccionada\n\n### Colecciones Firestore:\n- messages (nueva) - Todos los mensajes del chat\n- sales - Solo ventas (mantiene backward compatibility)\n- proofs - Solo comprobantes (mantiene backward compatibility)",
      "type": "general",
      "tags": [
        "general",
        "api",
        "feature",
        "chat",
        "messages",
        "implementation"
      ],
      "timestamp": "2025-12-28T19:34:18.579Z",
      "context": "Implementación del registro completo de chat con ventas interactivas",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T19:34:18.579Z",
      "lastVerified": "2025-12-28T19:34:18.579Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766952472015_rb4jtjazt",
      "content": "Chat history feature fully implemented and working as of Dec 28, 2025:\n- /chat page shows timeline of all messages from WhatsApp group\n- Messages with sales show preview on hover (SalePreviewCard component)\n- API /api/messages returns messages with pagination and filtering\n- Webhook saves ALL messages to 'messages' collection in Firestore\n- Build succeeded, dev server running on port 3004\n- 2 test messages visible: 1 reaction, 1 sale from Luis Alberto Ramirez (1000 USD Silver)",
      "type": "general",
      "tags": [
        "general",
        "api",
        "feature-complete",
        "chat-history",
        "working",
        "firestore"
      ],
      "timestamp": "2025-12-28T20:07:52.015Z",
      "context": "Completed implementation after fixing multiple issues with undefined values, TypeScript types, and build errors",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T20:07:52.015Z",
      "lastVerified": "2025-12-28T20:07:52.015Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766954936826_gqsptyc94",
      "content": "Fixed parser to handle \"Monto (USD): 32,6\" format (Dec 28, 2025):\n- Old regex only matched \"Monto: 100usd\" format\n- New regex: /Monto\\s*(?:\\(([^)]+)\\))?:\\s*(\\d+(?:[.,]\\d+)?)\\s*(usd|ars|euros?|pesos?)?/i\n- Now handles: \"Monto (USD): 32,6\", \"Monto: 100usd\", \"Monto(usd): 100\"\n- Parser updated to use 3 groups: [1]=currency in parens, [2]=amount, [3]=currency after\n- Build passes successfully",
      "type": "solution",
      "tags": [
        "solution",
        "bugfix",
        "parser",
        "regex",
        "monto"
      ],
      "timestamp": "2025-12-28T20:48:56.826Z",
      "context": "User found unrecognized sales with \"Monto (USD):\" format in chat timeline",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T20:48:56.826Z",
      "lastVerified": "2025-12-28T20:48:56.826Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766955260429_7gksvyune",
      "content": "Reprocessed unrecognized sales (Dec 28, 2025):\n- Created /api/reprocess endpoint\n- Found 2 new sales that weren't detected:\n  1. Celina María del Rosario Cabrera - $50 USD\n  2. Dustin uriel Tello - $32.6 USD\n- Sales now properly classified and added to sales collection\n- Chat improvements: reactions hidden, click popup for sales",
      "type": "general",
      "tags": [
        "general",
        "api",
        "reprocess",
        "sales",
        "fixed"
      ],
      "timestamp": "2025-12-28T20:54:20.429Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T20:54:20.429Z",
      "lastVerified": "2025-12-28T20:54:20.429Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766957116804_tfoyhyi4i",
      "content": "Chat improvements completed for Sales Tracker:\n\n1. **SaleDetailModal** (components/SaleDetailModal.tsx):\n   - Full-page modal using shadcn Dialog component\n   - Displays complete sale details: amount, client info, product, payment type, closer info\n   - Shows proof image from quotedMessage.mediaUrl or fetches from API\n   - Uses gradient header with prominent amount display\n   - Status badge with color-coded icons (verified/pending/rejected)\n   - Fetches additional data from /api/sales/[id] endpoint\n\n2. **API Endpoint** (app/api/sales/[id]/route.ts):\n   - New endpoint to fetch individual sale data by ID\n   - Returns full sale document from Firestore\n\n3. **MessageBubble Updates** (components/MessageBubble.tsx):\n   - Now uses SaleDetailModal instead of small SalePreviewCard popup\n   - Visual connection indicator: when a sale quotes a proof, it shows emerald-colored link with Link2 icon\n   - \"Toca para ver detalles completos\" hint on hover\n\n4. **Chat Page Improvements** (app/chat/page.tsx):\n   - Stats row with 3 cards: messages count, sales count, proofs count\n   - Better header with backdrop blur\n   - Improved filter dropdown using Card component\n   - Enhanced empty state with Card and better messaging\n   - Floating scroll button with rounded-2xl style\n\n5. **shadcn Components Installed**:\n   - dialog, card, badge, avatar, separator, scroll-area\n   - lib/utils.ts with cn() function\n   - components.json configuration",
      "type": "config",
      "tags": [
        "config",
        "api",
        "sales-tracker",
        "chat-improvements",
        "shadcn",
        "react",
        "ui-components"
      ],
      "timestamp": "2025-12-28T21:25:16.804Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T21:25:16.804Z",
      "lastVerified": "2025-12-28T21:25:16.804Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766958343141_gfyclpgds",
      "content": "Problema resuelto en Sales Tracker: Los errores 503 en Next.js fueron causados por el caché .next corrupto. Solución: eliminar el directorio .next y reiniciar el servidor de desarrollo. El servidor se movió del puerto 3002 al 3005 porque había múltiples procesos de node atascados en los puertos anteriores.",
      "type": "general",
      "tags": [
        "general",
        "next.js",
        "debug",
        "503-error",
        "cache",
        "sales-tracker"
      ],
      "timestamp": "2025-12-28T21:45:43.141Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T21:45:43.141Z",
      "lastVerified": "2025-12-28T21:45:43.141Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766962209159_fu3goojec",
      "content": "Fixed modal close bug in MessageBubble.tsx by moving SaleDetailModal OUTSIDE the clickable div using React Fragment (<>). The bug was caused by event propagation - when clicking modal overlay to close, the click propagated to parent div which had onClick={handleClick} that reopened the modal. Solution: wrap component in Fragment, close the clickable div before the modal.",
      "type": "error",
      "tags": [
        "error",
        "react",
        "registro_ventas_gp",
        "bug-fix",
        "modal",
        "event-propagation"
      ],
      "timestamp": "2025-12-28T22:50:09.159Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T22:50:09.159Z",
      "lastVerified": "2025-12-28T22:50:09.159Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766965362603_ctfyj11nf",
      "content": "Chat page redesign for registro_ventas_gp:\n\n1. VISUAL REFERENCE: Sale cards show thumbnail of quoted comprobante. Uses hasQuotedProof check: quotedMessage.classification?.isProof && (type === 'image' || 'document'). Clicking thumbnail opens lightbox.\n\n2. MESSAGE HIERARCHY:\n- isSale + parsedSale → Prominent green card with left border, large amount font\n- isProof → Amber themed card with zoom overlay\n- Regular chat → Minimal bg-white/[0.03] bubble, low opacity\n\n3. HEADER MINI-DASHBOARD:\n- Total amount: useMemo calculates sum of all parsedSale.amount\n- Closer chips: useMemo extracts unique closers from sales, assigns colors from CLOSER_COLORS array\n- Date picker: Calendar component with Spanish locale\n\n4. DARK THEME: bg-[#09090b], grid pattern via CSS background-image, gradient blur overlays\n\n5. FILTERS: selectedCloser state + closerColorMap for per-closer coloring",
      "type": "concept",
      "tags": [
        "concept",
        "registro_ventas_gp",
        "chat-redesign",
        "react",
        "ui-ux",
        "dark-theme"
      ],
      "timestamp": "2025-12-28T23:42:42.603Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-28T23:42:42.603Z",
      "lastVerified": "2025-12-28T23:42:42.603Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766970552745_hjfv2985i",
      "content": "Completed major improvements to Sales Tracker app:\n\n1. **Formateo números** - lib/format.ts with formatCurrency(), formatNumber() using es-AR locale for USD\n2. **Verificación en masa** - Checkbox in table, bulk-verify API endpoint, bulk actions UI\n3. **Export CSV** - lib/export.ts with salesToCSV(), downloads with semicolon separator for Excel\n4. **Responsive móvil** - Hidden columns on mobile, responsive grid layouts\n5. **Gráficos** - SalesChart.tsx with recharts (area, bar, pie charts)\n6. **Duplicados** - Detection algorithm comparing same closer+amount within 10 min\n7. **Image Viewer** - ImageViewer.tsx with zoom, rotate, keyboard shortcuts (+/-/R/0/Esc)\n8. **Dark/Light mode** - ThemeContext.tsx with toggle, localStorage persistence\n9. **Audit log** - audit_logs Firestore collection, API endpoint, Sheet UI\n10. **PWA** - next-pwa config, manifest.json, icon.svg\n\nNew files created:\n- lib/format.ts\n- lib/export.ts\n- contexts/ThemeContext.tsx\n- components/SalesChart.tsx\n- components/ImageViewer.tsx\n- components/ui/checkbox.tsx\n- components/ui/switch.tsx\n- components/ui/sheet.tsx\n- app/api/sales/bulk-verify/route.ts\n- app/api/audit-logs/route.ts\n- public/manifest.json\n- public/icon.svg\n\nPackages added: recharts, @radix-ui/react-checkbox, @radix-ui/react-switch, next-pwa",
      "type": "config",
      "tags": [
        "config",
        "react",
        "api",
        "sales-tracker",
        "improvements",
        "features",
        "completed"
      ],
      "timestamp": "2025-12-29T01:09:12.745Z",
      "accessCount": 0,
      "lastAccessed": "2025-12-29T01:09:12.745Z",
      "lastVerified": "2025-12-29T01:09:12.745Z",
      "status": "fresh"
    },
    {
      "id": "mem_1766971708634_u9zu9k8zc",
      "content": "Fixed SALE_PATTERNS regex in types/sales.ts to handle variations in sale messages:\n1. `nombre`: Changed from `/Nombre:\\s*/` to `/Nombre\\s*:\\s*/` - allows space before colon (NOMBRE :)\n2. `email`: Added `Correo` as alternative to `Email` - `/(?:Email|Correo)\\s*:\\s*(.+)/i`\n3. `producto`: Made colon optional - `/Producto\\s*:?\\s*(.+)/i` - handles \"PRODUCTO Silver 997\" without colon\n4. `tipoPago`: Now matches variations like \"Tipo de Unico:\" - `/Tipo(?:\\s+de\\s+(?:pago|[a-z]+))?\\s*:\\s*(.+)/i`\n\nAll patterns now have consistent `\\s*:\\s*` to handle spaces around colons.",
      "type": "solution",
      "tags": [
        "solution",
        "fix",
        "regex",
        "parser",
        "sales",
        "types/sales.ts"
      ],
      "timestamp": "2025-12-29T01:28:28.634Z",
      "context": "User showed screenshot of sale message not being detected. Issue was strict regex patterns.",
      "accessCount": 0,
      "lastAccessed": "2025-12-29T01:28:28.634Z",
      "lastVerified": "2025-12-29T01:28:28.634Z",
      "status": "fresh"
    }
  ],
  "lastUpdated": "2025-12-29T01:28:28.634Z"
}